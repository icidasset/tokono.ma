module Main exposing ( main )

import Browser exposing ( UrlRequest(..) )
import Browser.Navigation
import Common.String as String
import Markdown
import Messages as ViewMsg
import Types exposing (..)
import Url exposing ( Url )
import View exposing ( view )
import Json.Decode


-- ⛩️


type alias Flags =
    { pageRoute : Array String
    }


main : Program Flags Model Msg
main =
    Browser.application
        { init = init
        , view = view
        , update = update
        , subscriptions = subscriptions
        , onUrlRequest = UrlRequested
        , onUrlChange = UrlChanged
        }



-- 🌳


init :
    Flags
    -> Url
    -> Browser.Navigation.Key
    -> { model : Model
       , command : Cmd Msg
       }
init flags url key =
    let
        metadataDecoder =
          Json.Decode.map
            (\published ->
              { published = published
              }
            )
            (Json.Decode.field "published" Json.Decode.bool)

        parsed =
            Markdown.parse
                { frontmatter = Just (Markdown.jsonFrontmatter metadataDecoder)
                }
                """
                {
                  "published": false
                }

                ## H2 [link](#href)

                # H1 ``code``

                Testing a [link](#href). Some __more__ text.

                    code
                    line 2
                Not code.

                > Block*quote* with a [link](#href).

                ---
                ***
                ___

                ```
                Fenced code
                Line 2
                ```

                Para_graph_ **2**.

                - A
                 - Not nested
                - B
                  - Nested
                - C

                1. Ordered
                2. List
                """

        _ =
            Debug.log "" parsed

        rootUrl =
            url.path
                |> String.removePrefix "/"
                |> String.removeSuffix "/"
                |> String.split "/"
                |> Array.dropLast (Array.length flags.pageRoute)
                |> (\path ->
                        case path of
                            [] ->
                                ""

                            [ "" ] ->
                                ""

                            _ ->
                                "/" ++ String.join "/" path ++ "/"
                    )
                |> (\path -> { url | path = path })
    in
    { model =
        { navKey = key
        , rootUrl = rootUrl
        , url = url
        }
    , command = Cmd.none
    }



-- 📣


update :
    Msg
    -> Model
    -> { model : Model
       , command : Cmd Msg
       }
update msg model =
    case msg of
        ViewMsg (ViewMsg.NavigateToPage page) ->
            let
                url =
                    "/" ++ model.rootUrl.path ++ String.join "/" page.route ++ "/"
            in
            { model = model
            , command = Browser.Navigation.pushUrl model.navKey url
            }

        -- NAVIGATION
        UrlChanged url ->
            { model = { model | url = url }
            , command = Cmd.none
            }

        UrlRequested (External string) ->
            { model = model
            , command = Browser.Navigation.load string
            }

        UrlRequested (Internal url) ->
            { model = model
            , command = Browser.Navigation.pushUrl model.navKey (Url.toString url)
            }



-- 📰


subscriptions model =
    Sub.none
